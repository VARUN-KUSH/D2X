<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Anzeigen neu Generieren</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Roboto', Arial, sans-serif;
            max-width: 600px;
            min-width: 300px;
            padding: 20px;
            margin: 0 auto;
            background-color: #f4f4f4;
        }
        
        header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4A90E2;
        }
        
        h1 {
            font-size: 24px;
            margin: 0;
            color: #333333;
        }
        
        button {
            background-color: #4A90E2;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        button:hover {
            background-color: #357ABD;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            background-color: #2C5984;
        }
        
        label {
            display: block;
            margin-top: 20px;
            color: #555555;
            font-size: 14px;
        }
        
        select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #cccccc;
            border-radius: 4px;
            height: auto;
            min-height: 30px;
            font-size: 14px;
        }
        
        select:focus {
            border-color: #4A90E2;
            outline: none;
        }
        
        #status {
            margin-top: 20px;
            color: #333333;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Anzeige Neu Generieren</h1>
    </header>

    <button id="selectDirButton">Wähle das Hauptverzeichnis</button>
    <div id="status"></div>
    <div id="selectionDiv" style="display: none;">
        <label for="postSelect">Wähle die Posts:</label>
        <select id="postSelect" multiple></select><br>
        <button id="generateButton">Generiere Anzeige</button>
    </div>

    <script>
        function createHtmlDocument(
  userHandle,
  postNo,
  dateString,
  offenceType,
  sectionLineCounts = {}
) {
  // Default heights for each iframe class
  const defaultHeights = {
    "iframe-Abs_Adresse": 75,
    "iframe-Abs_Kontakt": 60,
    "iframe-unser_Zeichen": 45,
    "iframe-Empf_Adresse": 75,
    "iframe-Betreff": 45,
    "iframe-Datumszeile": 45,
    "iframe-AnzeigenEntwurf": 340,
    "iframe-Abs_UnterzeichnendePerson": 45,
    "iframe-Anlagen": 85,
    "iframe-AnalyseZeitpunkt": 45,
    "iframe-Post": 170,
    "iframe-Zeitpunkt": 45,
    "iframe-userHandle": 45,
    "iframe-screenname": 45,
    "iframe-profilUrl": 45,
    "iframe-postUrl": 45,
    "iframe-initialPostUrl": 45,
    "iframe-UserInfo": 170,
    "iframe-ExtraUserInfo": 170,
  };

  // Calculate heights based on line counts
  const heights = {};

  for (const className in defaultHeights) {
    if (sectionLineCounts.hasOwnProperty(className)) {
      const lineCount = sectionLineCounts[className];
      heights[className] = 30 + lineCount * 15;
    } else {
      heights[className] = defaultHeights[className];
    }
  }

  // Generate CSS styles for iframes
  let iframeStyles = "";

  for (const className in heights) {
    iframeStyles += `
                .${className} {
                    height: ${heights[className]}px;
                }
      `;
  }

  const template = `
        <!DOCTYPE html>
        <html lang="de">
        <head>
            <meta charset="UTF-8">
            <title>Anzeige_{{userHandle}}_{{postNo}}_{{offenceType}}_{{dateString}}</title>
            <style>
                @page {
                    size: A4;
                    margin-top: 3cm;
                    margin-bottom: 3cm;
                    margin-left: 2cm;
                    margin-right: 2cm;
                }
        
                html, body {
                    width: 100%;
                    margin: 0;
                    padding: 0;
                    font-family: monospace;
                    line-height: 1.6;
                }
        
                .container {
                    max-width: 21cm;
                    margin: 0 auto;
                    padding: 0;
                    position: relative;
                    width: 100%;
                }
        
                .right-align {
                    text-align: right;
                    position: relative;
                }
        
                .right-align iframe {
                    position: relative;
                    right: 0;
                    width: 50%;
                }
        
                .left-align {
                    text-align: left;
                }
        
                .address-block, .subject, .date-line, .content-block, .signature, .attachments {
                    clear: both;
                }
        
                h1, h2 {
                    color: #333;
                }
        
                .screenshot-section {
                    display: block;
                    margin: 0;
                    width: 100%;
                }
        
                .screenshot-section figcaption,
                .screenshot-section h2 {
                    margin: 0;
                    padding: 0;
                    font-size: 0.95em;
                    line-height: 1.2;
                    page-break-after: avoid;
                    break-after: avoid;
                }
        
                .screenshot {
                    display: block;
                    width: 100%;
                    height: auto;
                    margin: 0;
                    margin-top: -0.2cm;
                    object-fit: contain; /* Ensure image fits within container */
                }
        
                iframe {
                    width: 100%;
                    border: none;
                    overflow: hidden;
                }
        
                /* Adjusted initial heights based on content size */
                {{iframeStyles}}
        
                /* Additional styles for page breaks and section boundaries */
                .page-break {
                    page-break-before: always;
                }
        
                .section {
                    page-break-inside: avoid;
                }
        
                @media print {
                    /* Any print-specific styles can go here */
                }
            </style>
        </head>
        <body>
        
            <!-- Abs.Adresse.txt -->
            <div class="address-block right-align">
                <iframe src="Anschreiben_Basis_Daten/Abs.Adresse.txt" class="iframe-Abs_Adresse"></iframe>
            </div>
        
            <!-- Abs.Kontakt.txt -->
            <div class="address-block right-align">
                <iframe src="Anschreiben_Basis_Daten/Abs.Kontakt.txt" class="iframe-Abs_Kontakt"></iframe>
            </div>
        
            <!-- unser_Zeichen.txt -->
            <div class="address-block right-align">
                <iframe src="{{userHandle}}/{{postNo}}/unser_Zeichen.txt" class="iframe-unser_Zeichen"></iframe>
            </div>
        
            <!-- Empf.Adresse.txt -->
            <div class="address-block left-align">
                <iframe src="Anschreiben_Basis_Daten/Empf.Adresse.txt" class="iframe-Empf_Adresse"></iframe>
            </div>
        
            <!-- Betreff.txt -->
            <div class="subject left-align">
                <iframe src="Anschreiben_Basis_Daten/Betreff.txt" class="iframe-Betreff"></iframe>
            </div>
        
            <!-- Datumszeile.txt -->
            <div class="date-line right-align">
                <iframe src="Anschreiben_Basis_Daten/Datumszeile.txt" class="iframe-Datumszeile"></iframe>
            </div>
        
            <!-- AnzeigenEntwurf -->
            <div class="content-block left-align">
                <iframe src="{{userHandle}}/{{postNo}}/AnzeigenEntwurf_{{userHandle}}_{{postNo}}_{{dateString}}.txt" class="iframe-AnzeigenEntwurf"></iframe>
            </div>
        
            <!-- Abs.UnterzeichnendePerson.txt -->
            <div class="signature left-align">
                <iframe src="Anschreiben_Basis_Daten/Abs.UnterzeichnendePerson.txt" class="iframe-Abs_UnterzeichnendePerson"></iframe>
            </div>
        
            <!-- Anlagen.txt -->
            <div class="attachments left-align">
                <iframe src="Anschreiben_Basis_Daten/Anlagen.txt" class="iframe-Anlagen"></iframe>
            </div>
        
            <div class="page-break"></div>
        
            <!-- Sachverhalt Section -->
            <h1>Sachverhalt</h1>
        
            <div class="content-block left-align">
                <p>
                    Am <iframe src="AnalyseZeitpunkt.txt" class="iframe-AnalyseZeitpunkt" style="display: inline-block; vertical-align: middle;"></iframe>
                    wurde bei der Sichtung der Plattform x.com/Twitter folgender Inhalt festgestellt.
                </p>
            </div>
        
            <!-- Kommentar im Textformat -->
            <div class="content-block">
                <p><strong>Kommentar im Textformat:</strong></p>
                <blockquote>
                    <iframe src="{{userHandle}}/{{postNo}}/Post_{{userHandle}}_{{postNo}}_{{dateString}}.txt" class="iframe-Post"></iframe>
                </blockquote>
            </div>
        
            <!-- Eckdaten -->
            <div class="content-block left-align">
                <p><strong>Eckdaten:</strong>
                    <iframe src="{{userHandle}}/{{postNo}}/Zeitpunkt.txt" class="iframe-Zeitpunkt" style="display: inline-block; vertical-align: middle;"></iframe>
                    <iframe src="{{userHandle}}/userHandle.txt" class="iframe-userHandle" style="display: inline-block; vertical-align: middle;"></iframe>
                    <iframe src="{{userHandle}}/screenname.txt" class="iframe-screenname" style="display: inline-block; vertical-align: middle;"></iframe>
                    <iframe src="{{userHandle}}/profilUrl.txt" class="iframe-profilUrl" style="display: inline-block; vertical-align: middle;"></iframe>
                    <iframe src="{{userHandle}}/{{postNo}}/postUrl.txt" class="iframe-postUrl" style="display: inline-block; vertical-align: middle;"></iframe>
                    <iframe src="initialPostUrl.txt" class="iframe-initialPostUrl" style="display: inline-block; vertical-align: middle;"></iframe>
                </p>
            </div>
        
            <div class="page-break"></div>
        
            <!-- UserInfo Section -->
            <h2>Informationen aus dem Profil Tatverdächtige*r:</h2>
            <div class="content-block left-align">
                <iframe src="{{userHandle}}/UserInfo_{{userHandle}}_{{dateString}}.txt" class="iframe-UserInfo"></iframe>
                <iframe src="{{userHandle}}/ExtraUserInfo_{{userHandle}}_{{dateString}}.txt" class="iframe-ExtraUserInfo"></iframe>
            </div>
        
            <!-- Insert page break before the next screenshot -->
            <div class="page-break"></div>
        
            <!-- Screenshot of User Profile -->
            <div class="section">
                <h2>Screenshot Nutzerprofil auf X/Twitter</h2>
                <figure class="screenshot-section">
                    <img src="{{userHandle}}/screenshot_profile_{{userHandle}}_{{dateString}}.png" alt="Screenshot Profil" class="screenshot">
                </figure>
            </div>
        
            <!-- Insert page break before the next screenshot -->
            <div class="page-break"></div>
        
            <!-- Screenshot of Comment and Context -->
            <div class="section">
                <h2>Screenshot des Kommentars und Kontext:</h2>
                <figure class="screenshot-section">
                    <img src="{{userHandle}}/{{postNo}}/screenshot_{{userHandle}}_{{postNo}}_{{dateString}}.png" alt="Screenshot Kommentar" class="screenshot">
                </figure>
            </div>
        
        </body>
        </html>`;

  return template
    .replace("{{iframeStyles}}", iframeStyles)
    .replace(/{{userHandle}}/g, userHandle)
    .replace(/{{postNo}}/g, postNo)
    .replace(/{{dateString}}/g, dateString)
    .replace(/{{offenceType}}/g, offenceType);
}
    
        let parentDirectoryHandle = null;
        let postOptions = {}; // Object to store {userHandle}/{postNo} and their directory handles

        async function handleDirectorySelection() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerText = '';

            try {
                if ('showDirectoryPicker' in window) {
                    // Prompt user to select the parent directory
                    parentDirectoryHandle = await window.showDirectoryPicker();
                    statusDiv.innerText = 'Verzeichnis Picker geladen.'
                    // Scan the directory to find userHandles and posts
                    postOptions = {};
                    for await (const [name, handle] of parentDirectoryHandle.entries()) {
                        if (handle.kind === 'directory' && name !== 'Anschreiben_Basis_Daten') {
                            // This is a userHandle directory
                            statusDiv.innerText = 'User Ordner gefunden.'
                            const userHandle = name;
                            const userDirectoryHandle = handle;

                            // Now, scan for postNo directories
                            for await (const [postName, postHandle] of userDirectoryHandle.entries()) {
                                if (postHandle.kind === 'directory') {
                                    const postNo = postName;
                                    const optionKey = `${userHandle}/${postNo}`;
                                    postOptions[optionKey] = {
                                        userHandle: userHandle,
                                        postNo: postNo,
                                        userDirectoryHandle: userDirectoryHandle,
                                        postDirectoryHandle: postHandle
                                    };
                                }
                            }
                        }
                    }

                    if (Object.keys(postOptions).length === 0) {
                        statusDiv.innerText = 'Keine Posts gefunden.';
                        return;
                    }

                    // Populate the postSelect dropdown
                    const postSelect = document.getElementById('postSelect');
                    postSelect.innerHTML = '';
                    for (const optionKey in postOptions) {
                        const option = document.createElement('option');
                        option.value = optionKey;
                        option.text = optionKey;
                        option.selected = true; // Select all options by default
                        postSelect.appendChild(option);
                    }

                    // Show the selectionDiv
                    document.getElementById('selectionDiv').style.display = 'block';

                    statusDiv.innerText = 'Hauptverzeichnis ausgewählt. Alle Posts sind standardmäßig ausgewählt.';
                } else {
                    statusDiv.innerText = 'Der Browser unterstützt das benötigte File System Access API nicht.';
                }
            } catch (error) {
                console.error(error);
                statusDiv.innerText = 'Es gab einen Fehler beim Zugriff auf das Verzeichnis.';
            }
        }

        async function generateAnzeige() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerText = 'Generierung gestartet...';

            try {
                const postSelect = document.getElementById('postSelect');
                const selectedOptions = Array.from(postSelect.selectedOptions).map(option => option.value);

                if (selectedOptions.length === 0) {
                    statusDiv.innerText = 'Bitte wählen Sie mindestens einen Post aus.';
                    return;
                }

                let successCount = 0;
                let failureCount = 0;
                let failureDetails = '';

                for (const selectedOption of selectedOptions) {
                    const {
                        userHandle,
                        postNo,
                        userDirectoryHandle,
                        postDirectoryHandle
                    } = postOptions[selectedOption];

                    // Access Anschreiben_Basis_Daten directory
                    const baseDirHandle = await parentDirectoryHandle.getDirectoryHandle('Anschreiben_Basis_Daten');

                    // Read offenceType from Verfolgungsart.txt in post directory
                    const verfolgungsartFileHandle = await postDirectoryHandle.getFileHandle('Verfolgungsart.txt');
                    const verfolgungsartFileData = await verfolgungsartFileHandle.getFile();
                    const offenceType = (await verfolgungsartFileData.text()).trim();

                    // Read dateString from AnzeigenEntwurf filename
                    let dateString = '31.07.2024'; // Default date
                    for await (const [name, handle] of postDirectoryHandle.entries()) {
                        if (handle.kind === 'file' && name.startsWith(`AnzeigenEntwurf_${userHandle}_${postNo}_`)) {
                            const dateMatch = name.match(/_(\d{2}\.\d{2}\.\d{4})\.txt$/);
                            if (dateMatch) {
                                dateString = dateMatch[1];
                            }
                            break;
                        }
                    }

                    // Prepare sectionLineCounts
                    const sectionLineCounts = {};

                    // Function to read a file and count lines
                    async function readFileAndCountLines(dirHandle, fileName) {
                        const fileHandle = await dirHandle.getFileHandle(fileName);
                        const fileData = await fileHandle.getFile();
                        const content = await fileData.text();
                        return content.trim().split('\n').length;
                    }

                    // List of files and their corresponding iframe class names
                    const filesToRead = [
                        { dir: baseDirHandle, file: 'Abs.Adresse.txt', className: 'iframe-Abs_Adresse' },
                        { dir: baseDirHandle, file: 'Abs.Kontakt.txt', className: 'iframe-Abs_Kontakt' },
                        { dir: baseDirHandle, file: 'Empf.Adresse.txt', className: 'iframe-Empf_Adresse' },
                        { dir: baseDirHandle, file: 'Betreff.txt', className: 'iframe-Betreff' },
                        { dir: baseDirHandle, file: 'Datumszeile.txt', className: 'iframe-Datumszeile' },
                        { dir: baseDirHandle, file: 'Abs.UnterzeichnendePerson.txt', className: 'iframe-Abs_UnterzeichnendePerson' },
                        { dir: baseDirHandle, file: 'Anlagen.txt', className: 'iframe-Anlagen' },
                        { dir: postDirectoryHandle, file: `AnzeigenEntwurf_${userHandle}_${postNo}_${dateString}.txt`, className: 'iframe-AnzeigenEntwurf' },
                        { dir: postDirectoryHandle, file: `Post_${userHandle}_${postNo}_${dateString}.txt`, className: 'iframe-Post' },
                        { dir: userDirectoryHandle, file: `UserInfo_${userHandle}_${dateString}.txt`, className: 'iframe-UserInfo' },
                        { dir: userDirectoryHandle, file: `ExtraUserInfo_${userHandle}_${dateString}.txt`, className: 'iframe-ExtraUserInfo' },
                        // Add more files as needed
                    ];

                    try {
                        for (const fileInfo of filesToRead) {
                            try {
                                const lineCount = await readFileAndCountLines(fileInfo.dir, fileInfo.file);
                                sectionLineCounts[fileInfo.className] = lineCount;
                            } catch (err) {
                                console.warn(`Datei ${fileInfo.file} konnte nicht gelesen werden.`);
                            }
                        }

                        // Call createHtmlDocument function
                        const htmlContent = createHtmlDocument(userHandle, postNo, dateString, offenceType, sectionLineCounts);

                        // Save the generated HTML file
                        try {
                            // Attempt to save in the parent directory
                            const saveFileHandle = await parentDirectoryHandle.getFileHandle(`Anzeige_${userHandle}_${postNo}_${offenceType}_${dateString}.html`, { create: true });
                            const writableStream = await saveFileHandle.createWritable();
                            await writableStream.write(htmlContent);
                            await writableStream.close();

                            successCount++;
                        } catch (error) {
                            console.warn(`Konnte Anzeige für ${selectedOption} nicht im Hauptverzeichnis speichern. Versuche, einen Speicherort auszuwählen.`);
                            // Fallback to showSaveFilePicker
                            try {
                                const saveFileHandle = await window.showSaveFilePicker({
                                    suggestedName: `Anzeige_${userHandle}_${postNo}_${offenceType}_${dateString}.html`,
                                    types: [{
                                        description: 'HTML Document',
                                        accept: {'text/html': ['.html']}
                                    }]
                                });
                                const writableStream = await saveFileHandle.createWritable();
                                await writableStream.write(htmlContent);
                                await writableStream.close();

                                successCount++;
                            } catch (saveError) {
                                console.error(saveError);
                                failureCount++;
                                failureDetails += ` - ${selectedOption}: ${saveError.message}\n`;
                            }
                        }
                    } catch (postError) {
                        console.error(postError);
                        failureCount++;
                        failureDetails += ` - ${selectedOption}: ${postError.message}\n`;
                    }
                }

                // Update status messages
                let finalStatus = `Generierung abgeschlossen. Erfolgreich: ${successCount}, Fehlgeschlagen: ${failureCount}.`;
                if (failureCount > 0) {
                    finalStatus += `\nFehlerdetails:\n${failureDetails}`;
                }
                statusDiv.innerText = finalStatus;
            } catch (error) {
                console.error(error);
                statusDiv.innerText = 'Es gab einen Fehler beim Generieren der Anzeigen.';
            }
        }

        document.getElementById('selectDirButton').addEventListener('click', handleDirectorySelection);
        document.getElementById('generateButton').addEventListener('click', generateAnzeige);
    </script>
</body>
</html>
